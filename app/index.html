<!DOCTYPE html>
<html>
	<head>
		<title>SocialGPS</title>
		<meta charset="utf-8">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
		<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	</head>	
	
	<body>
		<div data-role="page" data-theme="a" id="homepage" class="page-map" style="width:100%; height:100%;">
			<div data-role="header"><h1>Social GPS</h1></div>
			<div id="navbar" data-theme="a" data-role="navbar" data-iconpos="top">
				<ul>
					<li>
						<a href="index.html" data-theme="a" data-icon="search" class="ui-btn-active ui-state-persist">Choose Destination</a>
					</li>
					<li>
						<a href="settings.html" data-theme="a" data-icon="gear">Settings</a>
					</li>
				</ul>
			</div>
			<div data-role="content" style="width:100%; height:100%; padding:0;"> 

				<section id="wrapper" style="width:100%; height:100%;">
					<label for="searchbar"></label>
					<input type="search" name="searchbar" id="searchbar" placeholder=" Address or Destination" value=""  />
					<button data-mini=true onclick="search();">Search</button>
					<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
					<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
					<article>
					  <p><span id="status">Locating...</span></p>
					</article>
					
					<script type="text/javascript">
						/*document.getElementById("searchbar").bind("change", function(event, ui) {
							alert('hi');
							});
						*/
						$('#homepage').live( 'pageinit',function(event){
						  //alert( 'This page was just enhanced by jQuery Mobile!' );
						});
						var service; var map; var searchBox; var latlng; var markersArray = [];
						function search() {
							for (var i = 0; i < markersArray.length; i++ ) {
								markersArray[i].setMap(null);
							  }
							  markersArray = [];
							var request = {
								location: latlng,
								radius: '1000',
								query: document.getElementById("searchbar").value
							};
							service.textSearch(request, callback);
						 }
						
						
						function success(position) {
						  var s = $('#status');
						  //if (s.className == 'success') return;
						  s.html("");
						  s.addClass("success");
						  
						  var mapcanvas = document.createElement('div');
						  mapcanvas.id = 'mapcanvas';
						  mapcanvas.style.height = '300px'; //TODO: how to make 100%
						  mapcanvas.style.width = '320px';
							
						  $('article').append(mapcanvas);
						  
						  latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
						  var myOptions = {
							zoom: 10,
							center: latlng,
							mapTypeControl: false,
							navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
							mapTypeId: google.maps.MapTypeId.ROADMAP
						  };
						  map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);
						  service = new google.maps.places.PlacesService(map);
						/*var input = document.getElementById("searchbar");
						var defaultBounds = map.getBounds();
						var searchBox = new google.maps.places.SearchBox(input, {
						  bounds: defaultBounds
						});alert('hey');*/
						  
						  var markerImage = "http://maps.google.com/intl/en_us/mapfiles/ms/micons/purple-dot.png";
						  var marker = new google.maps.Marker({
							  position: latlng, 
							  map: map, 
							  title:"You are here!",
							  icon: markerImage
						  });
						  
						  
						}
						
						/* Called when searching 
						var marker = [];
						google.maps.event.addListener(searchbar, 'places_changed', function() {
						  var places = searchbar.getPlaces();

						  for (var i = 0, marker; marker = markers[i]; i++) {
							marker.setMap(null);
						  }

						  markers = [];
						  var bounds = new google.maps.LatLngBounds();
						  for (var i = 0, place; place = places[i]; i++) {
							var image = new google.maps.MarkerImage(
								place.icon, new google.maps.Size(71, 71),
								new google.maps.Point(0, 0), new google.maps.Point(17, 34),
								new google.maps.Size(25, 25));

							var marker = new google.maps.Marker({
							  map: map,
							  icon: image,
							  title: place.name,
							  position: place.geometry.location
							});

							markers.push(marker);
							bounds.extend(place.geometry.location);
						  }
						  map.fitBounds(bounds);
						});
						
						
						*/
						function callback(results, status) {
							var bounds = new google.maps.LatLngBounds();
						  if (status == google.maps.places.PlacesServiceStatus.OK) {
							for (var i = 0; i < results.length; i++) {
							  var place = results[i];
							  var marker = new google.maps.Marker({
								position: results[i].geometry.location,
								map: map,
								title: results[i].name});
								markersArray.push(marker);
								bounds.extend(place.geometry.location);
							}
							 map.fitBounds(bounds);
						  }
						}
						
						
						function error(msg) {
						  var s = document.querySelector('#status');
						  s.innerHTML = typeof msg == 'string' ? msg : "failed";
						  s.className = 'fail';
						}
						
						if (navigator.geolocation) {
						  navigator.geolocation.getCurrentPosition(success, error);
						} else {
						  error('not supported');
						}
					</script>
				</section>	
			</div>
		</div>
	</body>
</html>